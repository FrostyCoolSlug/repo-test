name: Deploy Package Repos

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-package-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download latest release artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: |
          mkdir -p artifacts/deb artifacts/rpm artifacts/flatpak
          TAG=$(gh release view --repo frostycoolslug/beacn-utility --json tagName -q .tagName)
          echo "Latest release: $TAG"
          gh release download "$TAG" --repo frostycoolslug/beacn-utility --pattern "*.deb" --dir artifacts/deb
          gh release download "$TAG" --repo frostycoolslug/beacn-utility --pattern "*.rpm" --dir artifacts/rpm
          gh release download "$TAG" --repo frostycoolslug/beacn-utility --pattern "*.flatpak" --dir artifacts/flatpak

      - name: Install dependencies
        run: |
          sudo add-apt-repository -y ppa:flatpak/stable
          
          sudo apt-get update
          sudo apt-get install -y dpkg-dev rpm createrepo-c gnupg flatpak software-properties-common ostree

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Build Debian repo
        run: |
          mkdir -p repo/deb/binary
          cp artifacts/deb/*.deb repo/deb/binary/

          cd repo/deb/binary
          dpkg-scanpackages . /dev/null > Packages
          gzip -c Packages > Packages.gz

          # Create and sign Release files
          echo "Suite: stable" >> Release
          echo "Codename: stable" >> Release
          echo "Architectures: amd64" >> Release
          echo "Components: main" >> Release
          echo "Description: The Beacn on Linux APT repository" >> Release
          
          echo "Date: $(date -Ru)" >> Release
          
          # Add checksums
          echo "SHA256:" >> Release
          for file in Packages Packages.gz; do
            if [ -f "$file" ]; then
              SIZE=$(stat -c%s "$file")
              HASH=$(sha256sum "$file" | cut -d' ' -f1)
              echo " $HASH $SIZE $file" >> Release
            fi
          done

          gpg --batch --yes -u "Beacn on Linux" --detach-sign -o Packages.gz.gpg Packages.gz
          gpg --batch --yes -u "Beacn on Linux" --detach-sign -o Release.gpg Release
          gpg --batch --yes -u "Beacn on Linux" --clearsign -o InRelease Release

      - name: Build RPM repo
        run: |
          echo "%_gpg_name Beacn on Linux" > ~/.rpmmacros
          
          mkdir -p repo/rpm
          cp artifacts/rpm/*.rpm repo/rpm/

          # Sign RPMs
          for pkg in repo/rpm/*.rpm; do
            rpm --addsign "$pkg"
          done

          # Generate metadata
          createrepo_c repo/rpm

      - name: Build Flatpak repo
        run: |
          mkdir -p repo/flatpak
          ostree init --mode=archive --repo=repo/flatpak
          
          for bundle in artifacts/flatpak/*.flatpak; do
            [ -e "$bundle" ] || continue
            flatpak build-import-bundle repo/flatpak "$bundle" --gpg-sign="Beacn on Linux"
          done
          
          flatpak build-update-repo repo/flatpak --gpg-sign="Beacn on Linux" --prune

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./repo

      # eploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
